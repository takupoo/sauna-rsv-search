<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ã‚µã‚¦ãƒŠç©ºã">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§–</text></svg>">
  <title>ã‚µã‚¦ãƒŠæ•´ä½œæ‰€ ç©ºãæ </title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
      padding-top: max(env(safe-area-inset-top), 20px);
    }
    h1 { font-size: 1.5rem; text-align: center; margin-bottom: 10px; }
    .update { text-align: center; color: #666; font-size: 0.8rem; margin-bottom: 15px; }

    /* æ—¥ä»˜ã‚¿ãƒ– */
    .date-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 10px;
      margin-bottom: 15px;
      -webkit-overflow-scrolling: touch;
    }
    .date-tab {
      flex-shrink: 0;
      padding: 10px 16px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 20px;
      color: #aaa;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .date-tab.active {
      background: #4a90d9;
      color: #fff;
    }
    .date-tab .weekday { font-size: 0.75rem; opacity: 0.8; }
    .date-tab .day { font-weight: 600; }
    .date-tab.has-slots { border: 2px solid #4CAF50; }
    .date-tab.has-slots .day::after { content: ' â—'; color: #4CAF50; font-size: 0.6rem; }

    .program {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .program-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #ffd700;
      font-size: 1.1rem;
    }
    .slots { display: flex; flex-wrap: wrap; gap: 8px; }
    .slot {
      background: #4CAF50;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .no-slots { color: #888; font-size: 0.9rem; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .error { background: rgba(255,0,0,0.2); padding: 15px; border-radius: 12px; color: #ff6b6b; }
    .total-summary {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    .total-summary.empty {
      background: rgba(255, 107, 107, 0.2);
      border-color: #ff6b6b;
    }
    .total-count { font-size: 2rem; font-weight: bold; }
    .refresh-btn {
      display: block;
      width: 100%;
      padding: 15px;
      background: #4a90d9;
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 20px;
      cursor: pointer;
    }
    .refresh-btn:active { background: #3a7bc8; }
  </style>
</head>
<body>
  <h1>ğŸ§– ã‚µã‚¦ãƒŠæ•´ä½œæ‰€</h1>
  <div class="update" id="update"></div>
  <div class="date-tabs" id="dateTabs"></div>
  <div id="summary"></div>
  <div id="content">
    <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <script>
    let globalData = null;
    let selectedDate = null;

    const WEEKDAYS = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

    function formatDateTab(dateStr) {
      const date = new Date(dateStr + 'T00:00:00+09:00');
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekday = WEEKDAYS[date.getDay()];
      const isWeekend = date.getDay() === 0 || date.getDay() === 6;
      return { month, day, weekday, isWeekend };
    }

    function hasSlots(data, dateStr) {
      return data.programs.some(p => (p.slotsByDate[dateStr] || []).length > 0);
    }

    function renderDateTabs(data) {
      const container = document.getElementById('dateTabs');
      container.innerHTML = data.dates.map(dateStr => {
        const { month, day, weekday } = formatDateTab(dateStr);
        const hasSlotsClass = hasSlots(data, dateStr) ? 'has-slots' : '';
        const activeClass = dateStr === selectedDate ? 'active' : '';
        return `<button class="date-tab ${activeClass} ${hasSlotsClass}" data-date="${dateStr}">
          <div class="weekday">${weekday}</div>
          <div class="day">${month}/${day}</div>
        </button>`;
      }).join('');

      container.querySelectorAll('.date-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedDate = btn.dataset.date;
          renderDateTabs(data);
          renderContent(data, selectedDate);
        });
      });
    }

    function renderContent(data, dateStr) {
      const content = document.getElementById('content');
      const summaryEl = document.getElementById('summary');

      // åˆè¨ˆç©ºãæ æ•°
      const totalSlots = data.programs.reduce((sum, p) => sum + (p.slotsByDate[dateStr] || []).length, 0);
      summaryEl.innerHTML = `
        <div class="total-summary ${totalSlots === 0 ? 'empty' : ''}">
          <div class="total-count">${totalSlots}</div>
          <div>${totalSlots > 0 ? 'æ ã®ç©ºãã‚ã‚Šï¼' : 'ç©ºããªã—'}</div>
        </div>
      `;

      // å„ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
      let html = '';
      for (const program of data.programs) {
        const slots = program.slotsByDate[dateStr] || [];
        html += `<div class="program">
          <div class="program-title">${program.name}</div>
          <div class="slots">`;

        if (slots.length === 0) {
          html += '<span class="no-slots">ç©ºãæ ãªã—</span>';
        } else {
          slots.forEach(slot => {
            html += `<span class="slot">${slot.time}</span>`;
          });
        }
        html += '</div></div>';
      }

      content.innerHTML = html;
    }

    async function loadData() {
      const content = document.getElementById('content');
      const updateEl = document.getElementById('update');

      try {
        const response = await fetch('data/slots.json?' + Date.now());
        globalData = await response.json();

        const updated = new Date(globalData.updated_at);
        updateEl.textContent = `æœ€çµ‚æ›´æ–°: ${updated.toLocaleTimeString('ja-JP')}`;

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’åˆæœŸé¸æŠ
        const today = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Tokyo' });
        selectedDate = globalData.dates.includes(today) ? today : globalData.dates[0];

        renderDateTabs(globalData);
        renderContent(globalData, selectedDate);

      } catch (error) {
        content.innerHTML = `<div class="error">
          ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
          <small>${error.message}</small>
        </div>`;
      }
    }

    loadData();
  </script>
</body>
</html>
